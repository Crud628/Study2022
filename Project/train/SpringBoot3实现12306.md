# 第1章 课程介绍与学习指南

# 第2章 12306这个系统架构到底有多牛？

## 2.1  众多并发项目，为何选择12306

### 高并发场景有哪些？

商品秒杀，淘宝双11
微信支付宝平台
微博突发热点
用户操作日志
12306购票平台

### 为何选择12306？

业务复杂度高于淘宝双11，考验个人程序设计能力

- 动态库存
- 选座功能
- 线上线下
  持续高并发业务，需要更综合的高并发设计
- 不停的刷票
- 绝不能超卖

## 2.2  12306 是如何成为全球最忙碌的网站之一

### 12306有多忙碌

一天的请求量大概1600亿，平均180万/秒
平均一年售出30亿张，高峰期日售票能力达到了2000万张
高峰期1秒可卖出1300张票



### 如何解决忙碌问题

提高处理能力：QPS和TPS

- 堆积硬件
- 软件：Gemfire
- 算法：模型、逻辑

削峰

- 业务：验证码、分时段、排队
- 技术：限流、异步

## 2.3  百万人同时抢1万张票，系统如何保证其正常及稳定性？

### 持续秒杀高并发技术

前端

- 针对静态资源做CDN
- 页面静态化
- 倒计时&Loading
- 使用验证码削峰

后端

- 微服务-服务拆分
- 负载均衡
- 限流降级
- 缓存
- 令牌
- 异步处理

数据库

- 分库：业务分库、读写分离
- 分表：横向分表、纵向分表
- 冗余设计，反范式，空间换时间
- 分布式数据库

其它

- 分时段秒杀
- 弹性扩容
- 候补+排队

## 2.4  如何保证不超卖、不少买，还要承受极高的并发

# 模型设计&逻辑实现

余票查询：记录站站余票

- 一列火车有5个站，可拆分成4+3+2+1=10条站站记录

座位购买：记录座位销售详情

- 一列火车有5个站AE，1号座位：0111，代表只剩AB可买

## 2.5  12306核心系统功能讲解

![核心系统功能](https://typora-imagebed.oss-cn-beijing.aliyuncs.com/img/%E6%A0%B8%E5%BF%83%E7%B3%BB%E7%BB%9F%E5%8A%9F%E8%83%BD.jpg)

## 2.6  12306核心系统功能模块划分

gateway 网关模块：路由转发、登录校验
member 会员模块：会员、乘客、已购买的车票
business 业务模块：所有的车次数据、余票信息
batch 跑批模块：所有的定时任务，可通过界面启停
web 模块：会员相关界面
admin 模块：管理员相关界面

## 2.7  12306整体系统架构设计

简单的模块划分

![简单的模块划分](https://typora-imagebed.oss-cn-beijing.aliyuncs.com/img/%E7%AE%80%E5%8D%95%E7%9A%84%E6%A8%A1%E5%9D%97%E5%88%92%E5%88%86.jpg)

加入common模块，放置公共代码；制作generator代码生成器模块

![模块](https://typora-imagebed.oss-cn-beijing.aliyuncs.com/img/%E6%A8%A1%E5%9D%97.jpg)

加入中间件及微服务组件

![加入微服务组件](https://typora-imagebed.oss-cn-beijing.aliyuncs.com/img/%E5%8A%A0%E5%85%A5%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.jpg)



![完整技术架构](https://typora-imagebed.oss-cn-beijing.aliyuncs.com/img/%E5%AE%8C%E6%95%B4%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84.jpg)



## 2.8  12306系统数据库表讲解

会员模块：

- 会员表：手机号
- 乘客表：会员ID，姓名，身份证，旅客类型
- 车票表：会员ID，乘客ID，乘客姓名，日期，车次信息，座位信息

业务模块：

- 车站表：站名，站名拼音
- 车次表：车次编号，车次类型，始发站，出发时间，终点站，到站时间
- 到站表：车次编号，站名，进站时间，出站时间，停站时长，里程
- 车箱表：车次编号，箱号，座位类型，座位数，排数，列数
- 座位表：车次编号，箱号，排号，列号
- 每日车次表：日期，基础车次信息
- 每日到站表：日期，基础到站信息
- 每日车箱表：日期，基础车箱信息
- 每日座位表：日期，基础座位信息，销售详情
- 每日余票表：日期，车次编号，出发站，出发时间，到达站，到站时间，各种座位的余票信息

其它：

- quartz相关表
- seata相关表



# 第3章 最新版的SpringBoot3&JDK9~17新特性详解

## 3.1  JDK9新特性-`jshell`交互式工具

## 3.2  JDK9新特性-模块化开发

## 3.3  JDK10新特性-var局部变量推导

## 3.4  JDK11新特性-单文件程序

## 3.5  JDK11新特性-`shebang`脚本

## 3.6  JDK14新特性-文本块

## 3.7 JDK14 `instanceof`

```java
Object a = "123";
if (a instanceof String) {
    String b = (String) a;
    System.out.println(b);
}
if (a instanceof String b) {
    System.out.println(b);
}
```

## 3.8  JDK14  空指针提示

旧

```java
Exception in thread "main" java.lang.NullPointerException
	at com.jiawa2.Jiawa2.main(Jiawa2.java:46)
```

新

```java
Exception in thread "main" java.lang.NullPointerException: Cannot invoke "java.util.List.size()" because "a" is null
	at com.jiawa2.Jiawa2.main(Jiawa2.java:46)
```

## 3.9  JDK16新特性-record类

## 3.10  JDK17新特性-sealed类

## 3.11  JDK17新特性-switch增粥

## 3.12  SpringBoot3-AOT与JIT介绍

## 3.13  JIT在高并发场景中的生产问题分享

## 3.14  SpringBoot3-`GraalVM`代替JDK实现AOT



# 第4章 新版Spring Cloud Alibaba与`Springbooot`搭建后端架构



## 4.1 手把手快速完成微服务架构的搭建

如果依赖下载很慢，可到QQ群里下载settings.xml，配好了阿里镜像

## 4.2 项目初始化配置

修改encode
修改auto import
热部署配置：增加依赖会不生效

## 4.3 实现代码关联Gt远程仓库

实际工作中，每完成一个小功能，就提交一次，写清楚注释，下班前，代码全部push到远程仓库，前提是代码不要报错

代码一定要放远程仓库，防止电脑损坏丢失。一般公司会用gitlib自己搭仓库

远程仓库需要配置ssh
远程地址选择ssh（选择https需要用户名密码）

## 4.6 使用HTTP Client完成测过接口

如果依赖下载很慢，可到QQ群里下载settings.xml，配好了阿里镜像

## 4.7 增加AOP打印请求参数和返回结果

pom依赖和LogAspect代码可到源码中复制

## 4.8 详解项目中增加通用模块

增加common模块，用于放公共代码

增加公共配置文件，必须放在/config/目录下，否则无效（不是覆盖关系）；优先读公共配置下的配置

## 4.9 详解项目中增加网关模块

网关模块非常重要，可以用来做路由转发，权限校验等。

gateway是基于netty的，只有一个依赖，不能引入common，也不能引入starter-web

生产发布时，只有gateway需要配置外网IP，其它模块都只开放内网访问，外网访问不了，保证应用安全

要输出请求日志需要增加启动参数：
-Dreactor.netty.http.server.accessLogEnabled=true

## 4.10 详解本地数据库的准备工作

如果用本地数据库，请提前安装好Mysql8.0，用云数据库就不需要了

**重点：配置专库专用**
很多同学安装好库后，有了root用户，就直接开干了，完全没考虑以后项目多了会怎么样。

mysql版本使用8.0
本机演示使用5.7，不影响使用

客户端工具选择Navicat或DBeaver(免费，推荐)
使用root连接到本地mysql，配置专库专用
新建train数据库
新建train用户，只能连接train数据库

## 4.11 详解阿里云RDS的准备工作

**云数据库的好处**

- 免去环境搭建，版本任选
- 方便多台电脑协作开发
- 相当于雇了一帮运维
- 总结：花钱买时间

## 4.12 使用IDEA配置教据库连接

几个好处：

- 可直接执行sql脚本
- mybatis xml文件可以识别数据库表
- 可以IDEA里直接操作数据库，增删改查等

## 4.13 集成`Mybatis`持久层框架

为什么开发时，JDK及各种框架都不建议用最新版本，其中一个大原因，就是怕其依赖的第三方没有配套升级，导致不兼容。这也是为什么JDK1.8还是主流版本，因为本身稳，第三方框架也稳

## 4.14 集成`Mybatis`官方生成器

Mybatis官方代码生成器：Mybatis Generator

开发规范：生成器生成的4个文件都不能手动修改，自定义SQL需要写到自己的mapper里，不能放在生成的mapper里

## 4.16 封装请求参数和返回结果

前后端分离项目，需要对后端接口做统一封装，这样便于前端做统一处理。

## 4.17 为项目增加统一异常处理

两个作用：
1 对于业务异常，如：用户名密码错、用户名已存在等，通过抛出业务异常，中断流程，再通过最外层的统一异常处理，返回给前端错误信息。
2 对于可能出现的未知异常，如：空指针、唯一键冲突等，通过统一拦截，可以避免将一大堆异常信息返给前端

## 4.18 使用自定义异常处理异常业务

为了区分业务异常和系统异常，需要增加自定义异常类

“系统出现异常，请联系管理员”，生产运行过程中，都不应该出现这句话，这句是为了一些未知异常，统一话术给用户，出现了就说明系统有BUG，需要修改代码

## 4.19 集成校验框架Validation

Spring Boot Validation是Spring Boot整合了Hibernate Validation的一个框架, 其核心是Hibernate Validation,
此框架的作用: 检验客户端向服务器端提交的请求参数的基本格式是否合法

常用的检查注解有：

- @NotNull：不允许为null值
  可用于任何类型的参数
- @NotEmpty：不允许为空字符串，即长度为0的字符串
  仅用于检查字符串类型的参数
- @NotBlank：不允许为空白的字符串，即仅由空格或TAB制表位或换行组成的值
  仅用于检查字符串类型的参数
- @Length：限制字符串的长度
- @Pattern：通过正则表达式检查字符串的格式，此注解的regexp属性就是定义正则表达式的属性
  仅用于检查字符串类型的参数
- @Min：限制整型数值的最小值
  仅用于检查整型数值参数
- @Max：限制整型数值的最大值
  仅用于检查整型数值参数
- @Range：限制整型数值的取值区间，默认最小值为0，最大值为long的上限值
  仅用于检查整型数值参数

所有检查注解都有message属性，用于配置检查失败时的提示文本。

每个被检查参数可以同时添加多个检查注解！

## 4.20 详解雪花算法

自增ID不适合分布式数据库、分表分库场景，适合小型项目

UUID会影响索引效率，因为UUID是无序的，用一堆无序的ID来构建一个有序的索引目录，性能上肯定有问题的

雪花算法由Twitter 公司在2014年开源 scala 语言版本

![雪花算法](https://img.mukewang.com/wiki/640bf0b80815c7e509600320.jpg)

**雪花算法问题**

- 数据中心，机器ID怎么设置

  可在启动时，用IP或MAC到数据库中申请一个不重复的ID

- 时钟回拨

  一个应用一般是多节点，可停止节点，等时间过了，再启动

# 第5章 使用Vue3 + Vue CLI 实现系统前端模块的搭建

5.2本地环境准备
5.3 手把手创建基于Vue CLI的web模块
5.4 web模块集成Ant DesignVue
5.5 短信验证码登录流程讲解
5.6 注册登录二合一界面开发
5.7 发送短信验证码接口开发
5.9 集成Axios完成登录功能
510 增加Axios拦截器配置
511 Vue CLI多环境配置

# 第6章 实现JWT单点登录功能

6.3JWT单点登录原理与存在的问题及解决方案讲解
6.4 详解生成JWT单点登录token
6.5 使用vuex保存登录信息
6.6 wuex配合h5的session解决浏览器刷新问题
6.7 演示gateway拦截器的使用
6.9为axios请求增加统 拦截部
6.10 为路由页面增加登录拦截

# 第7章 12306系统会员基础功能的实现

7.2 详解乘车人表的设计
7.4 使用HttpClient保存登录信息
7.5 使用线程本地变量存储会员信息
7.8 乘车人列表查询接口开发
7.9 集成PageHelper实现后端分页
7.10 乘车人列表查询界面开发
7.11 解决Long类型精度丢失的问题
7.13 乘车人编辑界面开发
7.15 乘车人删除功能开发

# 第8章 自制前后端代码生成器提高开发效率

8.2 更换RDS教据库
8.3 剖析代码生成器的底层原理
8.4 集成dom4j读取xm
8.5 详解Service生成器
8.7 制作DBUil读取表字段信息
8.8 详解实体类生成器
8.9 按模块生成后端代码
8.10 详解vue界面生成器
8.11 详解前端枚举代码生成器

# 第9章 利用代码生成器快速实现火车基础数据的维护

9.2 更换远程代码仓库
9.3 项目中增加admin控台管理模块
9.4 项目中增加business业务模块
9.5 为business模块配置持久层生成器
9.6 快速生成车站基础教据管理功能
9.7 快速生成火车基础数据管理功能
9.8 快速生成火车车站基础数据管理功能
9.10 快速生成火车座位基础教据管理功能

9.11 使用pinyin-pro将汉字转成拼音
9.12 火车车站表单增加车次下拉选择
9.13 制作车次下拉框组件
9.14 制作车站下拉框组件
9.16 实现按车次生成车座功能
9.17 完善车次&车用&座位管理功能
9.18 为车次&车厢&车站增加存在性校验

# 第10章 使用调度框架quartz，为12306系统增加定时调度功能

10.2 项目中增加batch定时调
度模块
10.3 为batch模块配置持久层生成器
10.4 演示SpringBoot自带的定时任务
10.6 关于调度任务的并发执行
10.7 使用教据库配置quartz调度任务
10.8 通过控台界面提作定时任务
10.9 增加任务手工补偿功能
10.10 演示多节点场景中quartz的调度情况

# 第11章 通过火车基础数据生成每日火车数据

11.3 完善每日车次管理页面功能
11.6 快速生成每日座位数据管理功能
11.7 增加生成每日车次定时任努
11.8 集成OpenFeign实现服务间调用
11.9 增加生成每日车次功能
11.12 增加生成每日座位功能
11.13 增加手动生成某日车次数据功能

# 第12章 基本的车票预定功能开发

12.2 增加余票信息表以提高余票查询效率
12.3 生成车次时初始化余票信
息
12.6 为会员端增加余要查询功能本节分步进行，先做一个和控台一模一样的页面，再做修改，这样可以保存每步的提交记录，哪
12.7 增加订票页面并实现车次信息传递
12.8 订票页面勾选乘客并显示购票列表
12.9 分解选座购票功能的前后端逻辑

12.10 订票页面增加选座效果
12.11 增加确认订单表并生成前后端代码
12.12 后端增加确认下单购要接
12.13 确认下单接口数据初始况
12.14 预扣减库存并判断余票是否足够
12.15 计算多个选座之间的偏移值
12.17 根据座位销售详情判断本次是否可选
12.18 完成有选座的挑座位逻
12.20 选座成功后更新各座位
的销售详情

# 第13章 集成注册中心与配置中心组件`Nacos`（动态修改线上的配置）



# 第14章 高性能余票查询的实现（前端缓存&本地缓存&分布式缓存）



# 第15章 集成分布式事务组件`Seata`（解决分布式系统中的数据一致性问题） 



# 第16章 高并发抢票时，利用各种锁解决车票超卖问题（JDK锁&分布式锁&看门狗设计&红锁）



# 第17章 高并发抢票时，使用`Sentinal`组件进行请求限流降级（过滤90%的无效请求）



# 第18章 高并发抢票时，防止机器人刷票的令牌大闸，可减轻服务器的压力（防刷+限流）



# 第19章 利用流行的MQ组件对请求做削峰处理，解决吞吐量问题（实现最短时间内给用户反馈）



# 第20章 企业级项目上云（阿里云部署）



# 第21章 课程总结